#!/usr/bin/make -f
# -*- make -*-

CX ?= /opt/ppc32/cx
BUILD ?= build
CROSS := $(CX)/bin/powerpc-405-linux-gnu-

.PHONY: all setup link build cx-install
all: build

# Busybox explodes on parallel make.
build:
	$(MAKE) -j1 -C $(BUILD)

ifeq ($(words $(wildcard $(BUILD)/.config)),0)
build: setup
endif

setup: $(BUILD)/.config

ifdef LINK
link:
	mkdir -p $(LINK)/bin
	ln -sf $(BUILD)/busybox $(LINK)/bin/busybox
	ln -sf $(BUILD)/busybox.links $(LINK)/bin/busybox.links
endif

CX_FILES := $(BUILD)/busybox xbin/ \
            $(BUILD)/busybox.links xbin/

cx-install: build
	$(CX)/bin/cx-install -x $(CX) -b busybox -p glibc -c "busybox\ndir `/bin/pwd`\ncommit `git-rev-parse HEAD`" -- $(CX_FILES)

$(BUILD)/.config: .config
	mkdir -p $(BUILD)
	sed -e 's|CROSS_COMPILER_PREFIX.*|CROSS_COMPILER_PREFIX="$(CROSS)"|' < $< > $@
	$(MAKE) -j1 O=$(BUILD) oldconfig > /dev/null
